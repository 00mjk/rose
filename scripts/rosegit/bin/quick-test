#!/bin/bash
#
# A relatively quick and dirty test.
#    It runs "build" only if there's not configure script
#    It runs "configure" if the top-level makefile is out of date
#    It runs "make" in a variety of directories
#
# You may run it from anywhere in the build tree.
#
# See rat-test for additional documentation.

mydir=${0%/*}
source $mydir/rosegit-functions.sh || exit 1
rosegit_tester_preamble

# Run "build" if there's no configure file or there's a Makefile.am that's newer than configure
if [ ! -f $ROSE_SRC/configure ] || [ $(find $ROSE_SRC -name Makefile.am -newer $ROSE_SRC/configure |wc -l) -gt 0 ]; then
    rosegit_run "build" "(cd $ROSE_SRC && ./build)" || exit 1
fi

# Run "configure" if there's no Makefile or if configure is newer than the Makefile
if [ ! -f $ROSE_BLD/Makefile ] || [ $ROSE_BLD/configure -nt $ROSE_BLD/Makefile ]; then
    rosegit_run "configure" "(cd $ROSE_BLD && $ROSEGIT_CONFIGURE)" || exit 1
fi

rosegit_run "make (src)"               rosegit_make -C $ROSE_BLD/src || exit 1
rosegit_run "make (compass)"           rosegit_make -C $ROSE_BLD/projects/compass || exit 1
rosegit_run "make (Dan/Disassembler)"  rosegit_make -C $ROSE_BLD/developersScratchSpace/Dan/Disassembler_tests || exit 1
rosegit_run "make (Dan/translator)"    rosegit_make -C $ROSE_BLD/developersScratchSpace/Dan/translator_tests || exit 1
rosegit_run "make (Robb)"              rosegit_make -C $ROSE_BLD/developersScratchSpace/Robb || exit 1
