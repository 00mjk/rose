
#include "mfb-sage.hpp"

#include "sage3basic.h"

namespace MultiFileBuilder {

// Driver Ctor for Sage

template <>
Driver<Sage>::Driver(const std::string & filename_, SgProject * project_) :
  source_files(),
  header_files(),
  project(project_)
{
  if (!CommandlineProcessing::isCppFileNameSuffix("hpp"))
    CommandlineProcessing::extraCppSourceFileSuffixes.push_back("hpp");

  std::string filename;

  filename = filename_ + ".hpp";
  SgSourceFile * decl_file = isSgSourceFile(SageBuilder::buildFile(filename, filename, project));
  SageInterface::attachComment(decl_file, "/* File generated by SCSM::Driver<Sage> */");
  source_files.insert(decl_file);

  filename = filename_ + ".cpp";
  SgSourceFile * defn_file = isSgSourceFile(SageBuilder::buildFile(filename, filename, project));
  SageInterface::attachComment(defn_file, "/* File generated by SCSM::Driver<Sage> */");
  SageInterface::insertHeader(defn_file, filename_ + ".hpp");
  header_files.insert(defn_file);
}

// SgFunctionDeclaration

template <>
template <>
Sage<SgFunctionDeclaration>::build_result_t Driver<Sage>::build<SgFunctionDeclaration>(const Sage<SgFunctionDeclaration>::object_desc_t & desc) {
  Sage<SgFunctionDeclaration>::build_result_t result;

  Sage<SgFunctionDeclaration>::build_scopes_t scopes = getBuildScopes<SgFunctionDeclaration>(desc);

  SgScopeStatement * decl_scope = scopes.decl_scope;
  SgScopeStatement * defn_scope = scopes.defn_scope;

  SgFunctionDeclaration * func_decl = SageBuilder::buildNondefiningFunctionDeclaration(desc.name, desc.return_type, desc.params, decl_scope, NULL, false, NULL);
  SageInterface::appendStatement(func_decl, decl_scope);
  
  assert(func_decl->get_definition() == NULL);
  
  result.symbol = decl_scope->lookup_function_symbol(desc.name);
  assert(result.symbol != NULL);
  
  SgFunctionDeclaration * func_defn = SageBuilder::buildDefiningFunctionDeclaration(desc.name, desc.return_type, desc.params, defn_scope, NULL, false, func_decl, NULL);
  SageInterface::appendStatement(func_defn, defn_scope);
  
  result.definition = func_defn->get_definition();
  assert(result.definition != NULL);
  
  func_decl->set_definingDeclaration(func_defn);
  func_decl->set_firstNondefiningDeclaration(func_decl);
  
  func_defn->set_definingDeclaration(func_defn);
  func_defn->set_firstNondefiningDeclaration(func_decl);

  return result;
}

template <>
template <>
Sage<SgFunctionDeclaration>::build_scopes_t Driver<Sage>::getBuildScopes<SgFunctionDeclaration>(const Sage<SgFunctionDeclaration>::object_desc_t & desc) {
  Sage<SgFunctionDeclaration>::build_scopes_t result;

  assert(header_files.size() == 1);
  result.decl_scope = (*header_files.begin())->get_globalScope();

  assert(source_files.size() == 1);
  result.defn_scope = (*source_files.begin())->get_globalScope();

  return result;
}

// SgMemberFunctionDeclaration

template <>
template <>
Sage<SgMemberFunctionDeclaration>::build_result_t Driver<Sage>::build<SgMemberFunctionDeclaration>(const Sage<SgMemberFunctionDeclaration>::object_desc_t & desc) {
  Sage<SgMemberFunctionDeclaration>::build_result_t result;

  Sage<SgMemberFunctionDeclaration>::build_scopes_t scopes = getBuildScopes<SgMemberFunctionDeclaration>(desc);
  
  SgScopeStatement * decl_scope = scopes.decl_scope;
  SgScopeStatement * defn_scope = scopes.defn_scope;

  assert(isSgClassDefinition(decl_scope));

  SgMemberFunctionDeclaration * mfunc_decl = SageBuilder::buildNondefiningMemberFunctionDeclaration(desc.name, desc.return_type, desc.params, decl_scope, NULL, 0, false, NULL);
  SageInterface::appendStatement(mfunc_decl, decl_scope);

  assert(mfunc_decl->get_definition() == NULL);
  assert(mfunc_decl->get_associatedClassDeclaration() != NULL);

  result.symbol = isSgMemberFunctionSymbol(decl_scope->lookup_function_symbol(desc.name));
  assert(result.symbol != NULL);

  SgMemberFunctionDeclaration * mfunc_defn = SageBuilder::buildDefiningMemberFunctionDeclaration(desc.name, desc.return_type, desc.params, decl_scope, NULL, 0, false, mfunc_decl, NULL);
  SageInterface::appendStatement(mfunc_defn, defn_scope);

  assert(mfunc_defn->get_associatedClassDeclaration() != NULL);

  result.definition = mfunc_defn->get_definition();
  assert(result.definition != NULL);

  mfunc_decl->set_definingDeclaration(mfunc_defn);
  mfunc_decl->set_firstNondefiningDeclaration(mfunc_decl);

  mfunc_defn->set_definingDeclaration(mfunc_defn);
  mfunc_defn->set_firstNondefiningDeclaration(mfunc_decl);

  return result;
}

template <>
template <>
Sage<SgMemberFunctionDeclaration>::build_scopes_t Driver<Sage>::getBuildScopes<SgMemberFunctionDeclaration>(const Sage<SgMemberFunctionDeclaration>::object_desc_t & desc) {
  Sage<SgMemberFunctionDeclaration>::build_scopes_t result;

  assert(desc.parent != NULL);
  SgClassDeclaration * class_decl = desc.parent->get_declaration();
  assert(class_decl != NULL);
  class_decl = isSgClassDeclaration(class_decl->get_definingDeclaration());
  assert(class_decl != NULL);
  SgClassDefinition * class_defn = isSgClassDefinition(class_decl->get_definition());
  assert(class_defn != NULL);
  result.decl_scope = class_defn;

  assert(source_files.size() == 1);
  result.defn_scope = (*source_files.begin())->get_globalScope();

  return result;
}

// SgTemplateInstantiationMemberFunctionDecl

// SgTemplateInstantiationFunctionDecl

// SgClassDeclaration

template <>
template <>
Sage<SgClassDeclaration>::build_result_t Driver<Sage>::build<SgClassDeclaration>(const Sage<SgClassDeclaration>::object_desc_t & desc) {
  Sage<SgClassDeclaration>::build_result_t result;

  Sage<SgClassDeclaration>::build_scopes_t scopes = getBuildScopes<SgClassDeclaration>(desc);

  SgScopeStatement * decl_scope = scopes.decl_scope;

  SgClassDeclaration * class_decl = SageBuilder::buildNondefiningClassDeclaration_nfi(desc.name, (SgClassDeclaration::class_types)desc.kind, decl_scope, false, NULL);

  result.symbol = decl_scope->lookup_class_symbol(desc.name);
  assert(result.symbol != NULL);

  SgClassDeclaration * class_defn = SageBuilder::buildNondefiningClassDeclaration_nfi(desc.name, (SgClassDeclaration::class_types)desc.kind, decl_scope, false, NULL);
  SageInterface::appendStatement(class_defn, decl_scope);

  result.definition = SageBuilder::buildClassDefinition_nfi(class_defn, false);
  class_defn->set_definition(result.definition);
  class_defn->unsetForward(); 
  
  assert(class_decl->get_definition() == NULL);
  assert(class_defn->get_definition() != NULL);
  assert(!class_defn->isForward());

  class_decl->set_definingDeclaration(class_defn);
  class_decl->set_firstNondefiningDeclaration(class_decl);

  class_defn->set_definingDeclaration(class_defn);
  class_defn->set_firstNondefiningDeclaration(class_decl);

  return result;
}

template <>
template <>
Sage<SgClassDeclaration>::build_scopes_t Driver<Sage>::getBuildScopes<SgClassDeclaration>(const Sage<SgClassDeclaration>::object_desc_t & desc) {
  Sage<SgClassDeclaration>::build_scopes_t result;

  assert(source_files.size() == 1);
  result.decl_scope = (*header_files.begin())->get_globalScope();

  return result;
}

// SgTemplateInstantiationDecl

// SgTypedefDeclaration

// SgVariableDeclaration

template <>
template <>
Sage<SgVariableDeclaration>::build_result_t Driver<Sage>::build<SgVariableDeclaration>(const Sage<SgVariableDeclaration>::object_desc_t & desc) {
  Sage<SgVariableDeclaration>::build_result_t result;

  Sage<SgVariableDeclaration>::build_scopes_t scopes = getBuildScopes<SgVariableDeclaration>(desc);

  SgScopeStatement * decl_scope = scopes.scope;

  SgVariableDeclaration * var_decl = SageBuilder::buildVariableDeclaration(desc.name, desc.type, desc.initializer, decl_scope);

  result.symbol = decl_scope->lookup_variable_symbol(desc.name);
  assert(result.symbol != NULL);

  result.definition = var_decl->get_variables()[0];
  assert(result.definition != NULL);

  return result;
}

template <>
template <>
Sage<SgVariableDeclaration>::build_scopes_t Driver<Sage>::getBuildScopes<SgVariableDeclaration>(const Sage<SgVariableDeclaration>::object_desc_t & desc) {
  Sage<SgVariableDeclaration>::build_scopes_t result;

  if (desc.parent == NULL) {
    assert(header_files.size() == 1);
    result.scope = (*header_files.begin())->get_globalScope();
  }
  else {
    SgClassSymbol * class_symbol = isSgClassSymbol(desc.parent);
    SgNamespaceSymbol * namespace_symbol = isSgNamespaceSymbol(desc.parent);

    assert(class_symbol != NULL xor namespace_symbol != NULL);

    if (class_symbol != NULL) {
      result.scope = ((SgClassDeclaration *)class_symbol->get_declaration()->get_definingDeclaration())->get_definition();
    }
    if (namespace_symbol != NULL) {
      assert(false);
    }
    
    assert(result.scope != NULL);
  }

  return result;
}

// SgTemplateVariableDeclaration

// SgNamespaceDeclarationStatement

template <>
template <>
Sage<SgNamespaceDeclarationStatement>::build_result_t Driver<Sage>::build<SgNamespaceDeclarationStatement>(const Sage<SgNamespaceDeclarationStatement>::object_desc_t & desc) {
  Sage<SgNamespaceDeclarationStatement>::build_result_t result;

  Sage<SgNamespaceDeclarationStatement>::build_scopes_t scopes = getBuildScopes<SgNamespaceDeclarationStatement>(desc);

  SgScopeStatement * decl_scope = scopes.scope;

  SgNamespaceDeclarationStatement * nspc_decl = SageBuilder::buildNamespaceDeclaration(desc.name, decl_scope);

  result.symbol = decl_scope->lookup_namespace_symbol(desc.name);
  assert(result.symbol != NULL);

  result.definition = SageBuilder::buildNamespaceDefinition(nspc_decl);
  assert(result.definition != NULL);

  return result;
}

template <>
template <>
Sage<SgNamespaceDeclarationStatement>::build_scopes_t Driver<Sage>::getBuildScopes<SgNamespaceDeclarationStatement>(const Sage<SgNamespaceDeclarationStatement>::object_desc_t & desc) {
  Sage<SgNamespaceDeclarationStatement>::build_scopes_t result;

  if (desc.parent == NULL) {
    assert(header_files.size() == 1);
    result.scope = (*header_files.begin())->get_globalScope();
    // TODO result.scope = project->get_globalScope();
  }
  else {
    // SgNamespaceSymbol * namespace_symbol = desc.parent;
    // TODO get declaration attached to the gloabal scope
    assert(false);
  }

  return result;
}


}

