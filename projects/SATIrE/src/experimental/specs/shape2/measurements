#!/bin/bash

# runs srw/nnh on selected tests, generates gnuplots
# Viktor Pavlu, 2009

nnh99=build/nnh99/nnh99
srw98=build/srw98/srw98

report=report.txt

output_fields_per_row='testcase'
output_fields_per_analysis='time_analysis mem_analysis time_alias mem_alias sum_may_alias sum_must_alias'

OPTIONS="--callstringlength=42 --alias-statistics=tmp_alias-stats --statistics --var-alias-from-summary-graph"

function die {
  echo $@
  cat tmp_output
  echo "ABORTED"
  exit 1
}

function run_analysis {
  binary=$1
  testcase=$2

  ANALYSIS_NAME=srw98
  echo "$binary" | grep nnh99 > /dev/null 2>&1 && ANALYSIS_NAME=nnh99

  cmd="$binary $OPTIONS $testcase"
  echo
  echo $cmd
  time $cmd > tmp_output 2>&1 || die "$cmd failed"
  cat tmp_output

  # grep measurements
  str=`cat tmp_output | awk "/Run of analysis $ANALYSIS_NAME:/ {print \\$7, \\$11}"`
  time_analysis=`echo $str | cut -f 1 -d ' '`
  mem_analysis=`echo $str | cut -f 2 -d ' '`
  
  str=`cat tmp_output | awk "/Annotate AST with alias pairs:/ {print \\$8, \\$12}"`
  time_alias=`echo $str | cut -f 1 -d ' '`
  mem_alias=`echo $str | cut -f 2 -d ' '`

  sum_may_alias=`cat tmp_alias-stats | awk "/sum\(post may_alias\):/ {print \\$3}"`
  sum_must_alias=`cat tmp_alias-stats | awk "/sum\(post must_alias\):/ {print \\$3}"`

  val_line=''
  for field in $output_fields_per_analysis; do
    val_line="${val_line}${dollar}${field}${tab}"
  done
  eval echo -ne "$val_line" >> $report
}


echo
echo "calling analyses to generate gnuplot diagrams"
echo

# write comment to $report
echo -n "# generated by $@ on " > $report
date >> $report
echo '#' >> $report

function add_analysis_prefix {
  ANALYSIS_NAME=$1
  for fieldname in $output_fields_per_analysis; do
    echo -ne "${ANALYSIS_NAME}_${fieldname}\t" >> $report
  done
}

# write title row to $report
echo -ne "$output_fields_per_row\t" >> $report
add_analysis_prefix "nnh99"
add_analysis_prefix "srw98"
echo >> $report

dollar='$'
tab='\\t'

# write data rows to $report
find tests/gnuplot -type f -name \*.C | sort | while IFS= read -r testcase; do
  eval echo -ne "${dollar}${output_fields_per_row}${tab}" >> $report
  run_analysis "$nnh99" "$testcase"
  run_analysis "$srw98" "$testcase"
  echo >> $report
done

rm -f tmp_alias-stats tmp_output

