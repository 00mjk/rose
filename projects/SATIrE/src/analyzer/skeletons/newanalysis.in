#!/bin/bash

#if [ $# -ne 2 ]
#then
#    echo 
#    exit 1
#fi

# Debugging:
# set -x

# Command line options
while getopts ":u" Option
do
  case $Option in
    u) echo "Will not overwrite modified files"; UPDATE="T" ;;
    *) echo "usage: newanalysis [-uh] <name of analysis> <type of analysis carrier>"
       echo "If the -u option is specified, newanalysis will not overwrite any existing files."
       exit 1 ;;
  esac
done
shift $(($OPTIND - 1))

# Set default values
CURRENTDIR=`pwd`
if [ x$1 = x ]
then
    ANALYSIS_DIR=$CURRENTDIR
    ANALYSIS_NAME=`basename $CURRENTDIR`
else
    ANALYSIS_DIR=$1
    ANALYSIS_NAME=$1
fi

SATIRE_DATA="@pkgdatadir@"

# do the actual work
echo "creating new analysis $1..."
if [ -e "$ANALYSIS_DIR" ]
then
    echo "directory $ANALYSIS_DIR found."
else
    echo "creating directory $ANALYSIS_DIR ..."
    mkdir -p "$ANALYSIS_DIR"
fi
if [ -e "$ANALYSIS_DIR/anim-out" ]
then
    echo "directory $ANALYSIS_DIR/anim-out found."
else
    mkdir "$ANALYSIS_DIR/anim-out"
fi

echo "copying files..."
cp $SATIRE_DATA/main.h-template $ANALYSIS_DIR/main.h
cp $SATIRE_DATA/main-support.C-template $ANALYSIS_DIR/main-support.C
echo

if [ -e "$ANALYSIS_DIR/main.C" ]
then
  echo "$ANALYSIS_DIR/main.C exists and remains in $ANALYSIS_DIR. remove main.C and call $0 if you want a fresh copy."
else
  cp $SATIRE_DATA/main.C-template $ANALYSIS_DIR/main.C
fi

if [ -e "$ANALYSIS_DIR/${ANALYSIS_NAME}.set" ]
then
  echo "$ANALYSIS_DIR/$ANALYSIS_NAME.set exists and remains in $ANALYSIS_DIR."
else
 echo "You must create $ANALYSIS_DIR/$ANALYSIS_NAME.set before you can compile the analyzer $ANALYSIS_DIR/$ANALYSIS_NAME."
fi

if [ -e "$ANALYSIS_DIR/$ANALYSIS_NAME.optla" ]
then
 echo "$ANALYSIS_DIR/$ANALYSIS_NAME.optla exists and remains in $ANALYSIS_DIR."
 echo "customizing Makefile..."
 echo "ANALYSIS = $ANALYSIS_NAME" > $ANALYSIS_DIR/Makefile
 CARRIER_TYPE=`egrep 'carrier[ ]*:' $ANALYSIS_DIR/$ANALYSIS_NAME.optla | awk --field-separator ':' '{ print $2 }' | sed 's/ //g'`
 echo "CARRIER_TYPE = $CARRIER_TYPE" >> $ANALYSIS_DIR/Makefile
 cat $SATIRE_DATA/Makefile-template >> $ANALYSIS_DIR/Makefile
else
 echo "You must create $ANALYSIS_DIR/$ANALYSIS_NAME.optla before you can compile the analyzer $ANALYSIS_DIR/$ANALYSIS_NAME."
fi
echo
echo "All done, have fun."
